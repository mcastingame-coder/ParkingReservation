<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>Parking Reservation | ระบบจองที่จอดรถ</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- QR Code -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getDatabase, ref, push, set, get, child } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBeHQs4qOqXDYseMGmLRNlzOJesvgyUcS8",
      authDomain: "parking-reservation-8a90d.firebaseapp.com",
      databaseURL: "https://parking-reservation-8a90d-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "parking-reservation-8a90d",
      storageBucket: "parking-reservation-8a90d.appspot.com",
      messagingSenderId: "229489334106",
      appId: "1:229489334106:web:80f41505d329ace87b4563",
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // -------------------------------
    // ฟอร์แมตเวลาไทย
    // -------------------------------
    function formatThaiTime(ts) {
      return new Date(ts).toLocaleString("th-TH", {
        timeZone: "Asia/Bangkok",
        year: "numeric",
        month: "2-digit",
        day: "2-digit",
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit"
      });
    }

    // -------------------------------
    // ฟังก์ชันจอง
    // -------------------------------
    window.reserve = async function () {
      const phone = document.getElementById("phone").value.trim();
      const status = document.getElementById("status");
      const qrBox = document.getElementById("qrBox");
      const info = document.getElementById("info");

      status.innerHTML = "";
      qrBox.innerHTML = "";
      info.innerHTML = "";

      if (phone.length !== 10) {
        status.innerHTML = "<span class='text-red-500'>กรุณากรอกเบอร์ 10 หลัก</span>";
        return;
      }

      const dbRef = ref(db);

      // ตรวจสอบว่ามีเบอร์นี้อยู่หรือยัง
      const snap = await get(child(dbRef, "users/" + phone));

      if (snap.exists()) {
        // ——————————————
        // เคยจองแล้ว → แสดง QR เดิม
        // ——————————————
        const data = snap.val();
        status.innerHTML = "<span class='text-green-600 font-bold'>พบข้อมูลการจองเดิม</span>";

        info.innerHTML = `
          <div class="mt-4 text-gray-700">
            <p><b>หมายเลขจอง:</b> ${data.reservationId}</p>
            <p><b>เวลาจอง:</b> ${data.time_th}</p>
            <p class="text-blue-600"><b>สถานะ:</b> ${data.used ? "ใช้งานแล้ว" : "ยังไม่ใช้"}</p>
          </div>
        `;

        QRCode.toCanvas(qrBox, data.reservationId, { width: 220 });

        return;
      }

      // ——————————————
      // เบอร์ยังไม่เคยจอง → สร้างใหม่
      // ——————————————
      const resRef = push(ref(db, "reservations"));
      const resId = resRef.key;

      const now = Date.now();
      const timeTH = formatThaiTime(now);

      const reserveData = {
        id: resId,
        phone: phone,
        timestamp: now,
        time_th: timeTH,
        used: false
      };

      await set(resRef, reserveData);

      // บันทึก mapping สำหรับเบอร์โทร
      await set(ref(db, "users/" + phone), {
        reservationId: resId,
        time_th: timeTH,
        used: false
      });

      status.innerHTML = "<span class='text-green-600 font-bold'>จองสำเร็จ!</span>";

      info.innerHTML = `
        <div class="mt-4 text-gray-700">
          <p><b>หมายเลขจอง:</b> ${resId}</p>
          <p><b>เวลาจอง:</b> ${timeTH}</p>
        </div>
      `;

      QRCode.toCanvas(qrBox, resId, { width: 220 });
    };
  </script>

</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

  <div class="bg-white shadow-xl rounded-2xl p-8 max-w-md w-full text-center">
    
    <h1 class="text-2xl font-bold mb-2">Parking Reservation</h1>
    <p class="text-gray-600 mb-6">ระบบจองที่จอดรถ | Parking System</p>

    <!-- กรอกเบอร์ -->
    <input id="phone"
      class="w-full border rounded-lg p-3 text-lg mb-4 text-center"
      placeholder="กรอกเบอร์โทร / Phone number" maxlength="10">

    <button onclick="reserve()"
      class="bg-blue-600 text-white w-full py-3 rounded-lg text-lg hover:bg-blue-700 transition">
      จอง / Reserve
    </button>

    <div id="status" class="mt-4 text-lg"></div>

    <div id="info" class="mt-4"></div>

    <canvas id="qrBox" class="mx-auto mt-4"></canvas>

  </div>

</body>
</html>
