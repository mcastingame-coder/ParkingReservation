<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏î‡∏£‡∏ñ</title>

  <!-- QRCode library -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getDatabase, ref, push, set, get, child } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBeHQs4qOqXDYseMGmLRNlzOJesvgyUcS8",
      authDomain: "parking-reservation-8a90d.firebaseapp.com",
      databaseURL: "https://parking-reservation-8a90d-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "parking-reservation-8a90d",
      storageBucket: "parking-reservation-8a90d.appspot.com",
      messagingSenderId: "229489334106",
      appId: "1:229489334106:web:80f41505d329ace87b4563"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏ó‡∏¢
    function thaiTime(ts) {
      return new Date(ts).toLocaleString("th-TH", {
        timeZone: "Asia/Bangkok",
        year : "numeric",
        month: "2-digit",
        day  : "2-digit",
        hour : "2-digit",
        minute: "2-digit",
        second: "2-digit",
      });
    }

    // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏à‡∏≠‡∏á"
    window.bookSlot = async function () {
      const phone = document.getElementById("phone").value.trim();

      if (phone.length < 9) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
        return;
      }

      const dbRef = ref(db);

      // üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡πà‡∏≤‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÄ‡∏Ñ‡∏¢‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
      const snapshot = await get(child(dbRef, "reservations_by_phone/" + phone));

      if (snapshot.exists()) {
        const oldId = snapshot.val().id;

        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°
        const oldData = (await get(child(dbRef, "reservations/" + oldId))).val();

        document.getElementById("resId").innerText = oldId;

        // ‡πÇ‡∏ä‡∏ß‡πå QR ‡πÄ‡∏î‡∏¥‡∏°
        const qrBox = document.getElementById("qrBox");
        qrBox.innerHTML = "";
        QRCode.toCanvas(qrBox, oldId, { width: 200 });

        alert("‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÄ‡∏Ñ‡∏¢‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡πÅ‡∏™‡∏î‡∏á QR ‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏´‡πâ");
        return;
      }

      // üÜï ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
      const newRef = push(ref(db, "reservations"));
      const reservationId = newRef.key;

      const ts = Date.now();

      const data = {
        id: reservationId,
        phone: phone,
        timestamp: ts,
        time_th: thaiTime(ts),
        used: false
      };

      // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á
      await set(newRef, data);

      // map ‡πÄ‡∏ö‡∏≠‡∏£‡πå ‚Üí id
      await set(ref(db, "reservations_by_phone/" + phone), { id: reservationId });

      // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
      document.getElementById("resId").innerText = reservationId;

      const qrBox = document.getElementById("qrBox");
      qrBox.innerHTML = "";
      QRCode.toCanvas(qrBox, reservationId, { width: 200 });

      alert("‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
    };
  </script>

  <!-- STYLE UI -->
  <style>
    body {
      font-family: "Prompt", sans-serif;
      background: #f3f6fa;
      display: flex;
      justify-content: center;
      padding-top: 60px;
    }

    .card {
      background: white;
      width: 420px;
      padding: 30px;
      border-radius: 18px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
      text-align: center;
    }

    h1 {
      margin-bottom: 20px;
      color: #1d3557;
    }

    input {
      width: 85%;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid #999;
      margin-bottom: 15px;
      font-size: 18px;
      text-align: center;
    }

    button {
      width: 90%;
      padding: 14px;
      background: #457b9d;
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 20px;
      cursor: pointer;
      transition: 0.2s;
    }

    button:hover {
      background: #1d3557;
    }

    #qrBox {
      margin-top: 20px;
    }
  </style>

</head>

<body>

  <div class="card">
    <h1>‡∏à‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏î‡∏£‡∏ñ</h1>

    <input id="phone" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠" />

    <button onclick="bookSlot()">‡∏à‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏î</button>

    <h3>‡∏£‡∏´‡∏±‡∏™‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</h3>
    <div id="resId" style="font-size: 22px; color: #333;"></div>

    <h3>QR Code</h3>
    <canvas id="qrBox"></canvas>
  </div>

</body>
</html>
