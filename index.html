<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getDatabase, ref, push, set, get, child } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBeHQs4qOqXDYseMGmLRNlzOJesvgyUcS8",
    authDomain: "parking-reservation-8a90d.firebaseapp.com",
    databaseURL: "https://parking-reservation-8a90d-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "parking-reservation-8a90d",
    storageBucket: "parking-reservation-8a90d.appspot.com",
    messagingSenderId: "229489334106",
    appId: "1:229489334106:web:80f41505d329ace87b4563",
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const btn = document.querySelector("button");
  const resDiv = document.getElementById("resId");
  const qrBox = document.getElementById("qrBox");

  // ----------------------------
  // แสดงเวลาไทย
  // ----------------------------
  function formatThaiTime(ts) {
    return new Date(ts).toLocaleString("th-TH", {
      timeZone: "Asia/Bangkok",
      year: "numeric",
      month: "2-digit",
      day: "2-digit",
      hour: "2-digit",
      minute: "2-digit",
      second: "2-digit",
    });
  }

  // ----------------------------
  // เช็คว่าจองแล้วหรือยัง
  // ----------------------------
  const reservedId = localStorage.getItem("myReservation");

  if (reservedId) {
    btn.disabled = true;
    btn.innerText = "จองแล้ว";
    showOldReservation(reservedId);
  }

  async function showOldReservation(id) {
    resDiv.innerText = id;
    qrBox.innerHTML = "";
    QRCode.toCanvas(qrBox, id, { width: 180 });
  }

  // ----------------------------
  // ฟังก์ชันจองที่จอด
  // ----------------------------
  window.bookSlot = async function () {
    btn.disabled = true;
    btn.innerText = "จองแล้ว";

    const refData = push(ref(db, "reservations"));
    const id = refData.key;

    const now = Date.now();
    const timeTH = formatThaiTime(now);

    const data = {
      id: id,
      timestamp: now,
      time_th: timeTH,
      used: false
    };

    await set(refData, data);

    // เก็บไว้ใน localStorage กันกดซ้ำ
    localStorage.setItem("myReservation", id);

    resDiv.innerText = id;
    qrBox.innerHTML = "";
    QRCode.toCanvas(qrBox, id, { width: 180 });
  };
</script>
